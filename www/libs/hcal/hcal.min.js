/*jslint browser: true*/
/*global $, jQuery*/

/**
 * The jQuery plugin namespace.
 * @external "jQuery.fn"
 * @see {@link http://learn.jquery.com/plugins/|jQuery Plugins}
 */

/**
 * A jQuery plugin to create a iOS like calendar
 * @function external:"jQuery.fn".starfairy
 */
(function ($) {
    'use strict';
    
    var $container,
      $hcal,
      $hcalHeader,
      month,
      weekday,
      FECHA,
      $hcalBody;
  
    /**
     * Creates the header
     *
     * @memberOf external:"jQuery.fn".hcal
     * @private
     * @param {array} dates The dates
     * @param {number} markerpos The position which day should be marked with a circle in the header
     * @param {today} today The today string
     * @param {string} format 'us' or 'ger'
     * @return {jQuery} The header
     */
    function createHcalHeader(NUM) {
      var d   = new Date();
          d.setDate(d.getDate()+NUM);

      var DIA = d.getDate();
      var ANO = d.getFullYear();

      if(LANGUAJE == "EN"){
        weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        month   = ["December","January","February","March","April","May","June","July","August","September","October","November"];
      }else{
        weekday = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];
        month   = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembe","Diciembre"];
      }
  
      var today   = weekday[d.getDay()]+', '+month[d.getMonth()]+' '+DIA+' '+ANO
      var $header = $('<div class="hcal-header">');
      $('<div class="hcal-header-today">').text(today).appendTo($header);

      var DIA1 = (d.getDate()+1) < 10 ? "0"+d.getDate() : d.getDate();
      var MES1 = (d.getMonth()+1) < 10 ? "0"+d.getMonth() : d.getMonth();

      FECHA = DIA1+"/"+MES1+"/"+d.getFullYear();
      
      return $header;
    }
    
    /**
     * Creates the body
     *
     * @param {string} format 'us' or 'ger'
     * @return {jQuery} The body
     */
    function createHcalBody() {
      var $body = $('<div class="hcal-body" style="margin-top:58px;">'),
        i = 0,$row,$time,timevalue,$hr;
      
      for (i = 8; i < 25; i = i + 1) {
        timevalue = i + ':00';
        $row  = $("<div onclick=\"openFormEventByType(this, "+i+", '"+FECHA+"');\" class=\"ap-add-calendar hcal-body-row\" data-hora=\""+i+"\">").appendTo($body);
        $time = $('<div class="hcal-body-row-time">').text(timevalue).appendTo($row);
        $hr   = $('<div class="hcal-body-row-hr">').appendTo($row);
      }
      
      return $body;
    }
    
    /**
     * Initializes this plugin
     *
     * @param {jQuery} el The container element
     * @param {array} dates The dates
     * @param {number} markerpos The position which day should be marked with a circle in the header
     * @param {string} today The today-string
     * @param {string} format 'us' or 'ger' (2am vs. 02:00)
     */
    function init(el, NUM) {
      $container = el;
      $hcal = $('<div class="hcal">');
      
      $hcalHeader = createHcalHeader(NUM).appendTo($hcal);
      $hcalBody   = createHcalBody().appendTo($hcal);
      
      $hcal.appendTo($container);
    }
    
    /**
     * Adds a new appointment
     *
     * @param {number} position A number between 0-24 where to put the appointment
     * @param {number} duration The duration in hours
     * @param {string} title The title
     * @param {string} place Where the appointment will be
     * @param {string} desc A short description
     * @param {any} color Choose one of four colors (e.g. 1) or use a custom rgb color value e.g. [106,181,127]
     * @return {jQuery} The selected element
     */
    $.fn.addHcalAppointment = function (position, duration, title, place, desc, color, ID) {
      var $row    = $hcalBody.children('.hcal-body-row:nth-child(' + (position - 7) + ')'),
        $item     = $('<div class="hcal-body-row-item">'),
        $headline = $('<h3 class="hcal-body-row-item-headline">').appendTo($item),
        $desc     = $('<div class="hcal-body-row-item-text">').text(desc).appendTo($item),
        rgbaStringFull,
        rgbaStringTransparent;
      
      // Set headline and place
      $headline.html(title + '<span class="hcal-item-nr"> | ' + place + '</span>');
      
      // Set duration
      $item.addClass('hcal-duration-' + duration + 'h');
      $item.addClass('ap-calendar');
      $item.attr("data-id", ID);
      
      // Set color
      if (Object.prototype.toString.call(color) === '[object Array]') {
        rgbaStringFull = 'rgba(' + color[0] + ', ' + color[1] + ', ' + color[2] + ', 1)';
        rgbaStringTransparent = 'rgba(' + color[0] + ', ' + color[1] + ', ' + color[2] + ', 0.7)';
        $item.css({
          'background': rgbaStringTransparent,
          'border-left': '2px solid ' + rgbaStringFull
        });
      } else {
        $item.addClass('hcal-body-item-color0' + color);
      }
      
      $item.prependTo($row);
      $item.parent().removeClass("ap-add-calendar");
      
      return this;
    };
  
    /**
     * Register plugin
     *
     * @param {array} dates The dates
     * @param {number} markerpos The position which day should be marked with a circle in the header
     * @param {string} today The today-string
     * @param {string} format 'us' or 'ger' (2am vs. 02:00)
     * @return {jQuery} The selected element
     */
    $.fn.hcal = function (NUM) {
      init(this, NUM);
      return this;
    };
  
  }(jQuery));